name: Gemini AI Auto Code Fixer

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Git
        run: |
          git config --global user.name "Gemini AI Bot"
          git config --global user.email "gemini-ai@github-actions.local"
          
      - name: Create working branch
        run: |
          BRANCH_NAME="gemini-fix-${{ github.event.issue.number }}-$(date +%s)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b "$BRANCH_NAME"
          
      - name: Analyze and Fix Issue with Gemini
        uses: google-github-actions/run-gemini-cli@main
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            Sen deneyimli bir yazÄ±lÄ±m geliÅŸtiricisisin. AÅŸaÄŸÄ±daki GitHub issue'sunu analiz et ve GEREKLÄ° DOSYA DEÄÄ°ÅÄ°KLÄ°KLERÄ°NÄ° YAP.
            
            **Issue Bilgileri:**
            - BaÅŸlÄ±k: ${{ github.event.issue.title }}
            - AÃ§Ä±klama: ${{ github.event.issue.body }}
            - Issue No: #${{ github.event.issue.number }}
            
            **GÃ¶revin:**
            1. Issue'yu anlayÄ±p problemi tespit et
            2. Hangi dosyalarÄ±n deÄŸiÅŸtirilmesi gerektiÄŸini belirle
            3. Gerekli kod deÄŸiÅŸikliklerini YAP (sadece analiz etme, gerÃ§ekten deÄŸiÅŸtir)
            4. EÄŸer bu bir bug ise dÃ¼zelt, feature request ise implement et
            5. DeÄŸiÅŸiklikleri git'e commit et
            
            **Ã–nemli Kurallar:**
            - Sadece gerekli dosyalarÄ± deÄŸiÅŸtir
            - Mevcut kod stilini koru
            - Test dosyalarÄ±nÄ± da gÃ¼ncelle gerekirse
            - Breaking changes yapmamaya Ã§alÄ±ÅŸ
            - Her deÄŸiÅŸiklikten sonra dosyayÄ± kaydet
            
            **Git KomutlarÄ±:**
            DeÄŸiÅŸiklikleri yaptÄ±ktan sonra:
            ```bash
            git add .
            git commit -m "fix: Issue #${{ github.event.issue.number }} - [kÄ±sa aÃ§Ä±klama]"
            ```
            
            Hemen iÅŸe baÅŸla ve gerekli dosyalarÄ± dÃ¼zenle!

      - name: Check if changes were made
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "DeÄŸiÅŸiklikler tespit edildi:"
            git status --short
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "HiÃ§ deÄŸiÅŸiklik yapÄ±lmadÄ±"
          fi
          
      - name: Commit changes if any
        if: steps.check_changes.outputs.changes_made == 'true'
        run: |
          git add .
          git commit -m "fix: Issue #${{ github.event.issue.number }} - Gemini AI tarafÄ±ndan otomatik dÃ¼zeltme" || echo "Commit already made"
          
      - name: Push changes and create PR
        if: steps.check_changes.outputs.changes_made == 'true'
        run: |
          git push origin "$BRANCH_NAME"
          
      - name: Create Pull Request
        if: steps.check_changes.outputs.changes_made == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "ğŸ¤– Auto-fix: ${{ github.event.issue.title }}"
          body: |
            ## ğŸ¤– Gemini AI Otomatik DÃ¼zeltmesi
            
            Bu PR, **#${{ github.event.issue.number }}** numaralÄ± issue iÃ§in Gemini AI tarafÄ±ndan otomatik olarak oluÅŸturulmuÅŸtur.
            
            ### ğŸ“‹ Issue DetaylarÄ±
            **BaÅŸlÄ±k:** ${{ github.event.issue.title }}
            **Link:** https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}
            
            ### ğŸ”§ YapÄ±lan DeÄŸiÅŸiklikler
            Gemini AI aÅŸaÄŸÄ±daki deÄŸiÅŸiklikleri yaptÄ±:
            - Otomatik kod analizi ve dÃ¼zeltme
            - Issue'da belirtilen problemin Ã§Ã¶zÃ¼mÃ¼
            - Mevcut kod stiline uygun gÃ¼ncellemeler
            
            ### âš ï¸ Ä°nceleme Gerekli
            Bu PR otomatik olarak oluÅŸturulduÄŸu iÃ§in lÃ¼tfen:
            - [ ] Kod deÄŸiÅŸikliklerini dikkatli inceleyin
            - [ ] Testlerin geÃ§tiÄŸini kontrol edin
            - [ ] Breaking changes olmadÄ±ÄŸÄ±nÄ± doÄŸrulayÄ±n
            - [ ] GÃ¼venlik aÃ§Ä±klarÄ±nÄ±n bulunmadÄ±ÄŸÄ±nÄ± kontrol edin
            
            ### ğŸš€ Test Ã–nerileri
            ```bash
            # Bu branch'Ä± local'e Ã§ekin
            git checkout ${{ env.BRANCH_NAME }}
            
            # Testleri Ã§alÄ±ÅŸtÄ±rÄ±n
            npm test
            # veya
            python -m pytest
            # veya proje tipinize uygun test komutu
            ```
            
            ---
            **Not:** Bu deÄŸiÅŸiklikler AI tarafÄ±ndan yapÄ±lmÄ±ÅŸtÄ±r. Merge etmeden Ã¶nce kapsamlÄ± bir inceleme yapmanÄ±z Ã¶nerilir.
            
            Closes #${{ github.event.issue.number }}
          delete-branch: true
          
      - name: Comment on issue if changes made
        if: steps.check_changes.outputs.changes_made == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Gemini AI Otomatik DÃ¼zeltmesi TamamlandÄ±!
              
              Issue iÃ§in otomatik kod dÃ¼zeltmesi yapÄ±ldÄ± ve pull request oluÅŸturuldu.
              
              ğŸ“¥ **Pull Request:** YakÄ±nda oluÅŸturulacak PR'Ä± kontrol edin
              ğŸ” **YapÄ±lan:** Kod analizi ve otomatik dÃ¼zeltme
              â° **SÃ¼re:** $(date)
              
              LÃ¼tfen PR'Ä± inceleyin ve test edin!`
            });
            
      - name: Comment on issue if no changes
        if: steps.check_changes.outputs.changes_made == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Gemini AI Analiz Sonucu
              
              Issue analiz edildi ancak otomatik kod deÄŸiÅŸikliÄŸi yapÄ±lamadÄ±.
              
              **OlasÄ± nedenler:**
              - Issue daha fazla aÃ§Ä±klama gerektirebilir
              - Manuel mÃ¼dahale gerektiren bir durum
              - Mevcut kodda deÄŸiÅŸiklik gerektirmeyen bir Ã¶neri
              
              ğŸ’¡ **Ã–neri:** Issue'yu daha detaylÄ± aÃ§Ä±klayarak tekrar deneyin veya geliÅŸtiricilere etiketleyin.`
            });