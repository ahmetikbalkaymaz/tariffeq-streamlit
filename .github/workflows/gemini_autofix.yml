name: Gemini AI Auto Code Fixer

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # 15 dakika timeout
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Git
        run: |
          git config --global user.name "Gemini AI Bot"
          git config --global user.email "gemini-ai@github-actions.local"
          
      - name: Create working branch
        run: |
          BRANCH_NAME="gemini-fix-${{ github.event.issue.number }}-$(date +%s)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b "$BRANCH_NAME"
          
      - name: Show initial status
        run: |
          echo "🚀 İşlem başlatılıyor..."
          echo "📁 Mevcut dosyalar:"
          find . -name "*.js" -o -name "*.py" -o -name "*.css" -o -name "*.html" -o -name "*.md" | head -10
          echo "📊 Toplam kod dosyası: $(find . -name "*.js" -o -name "*.py" -o -name "*.css" -o -name "*.html" | wc -l)"
          
      - name: Comment on issue - Starting
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 🤖 Gemini AI İşlem Başlatıldı
              
              ⏰ **Başlangıç:** ${new Date().toLocaleString('tr-TR')}
              🔍 **Durum:** Issue analiz ediliyor ve kod değişiklikleri yapılıyor...
              📊 **Workflow:** [Detaylı log için tıklayın](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              💡 Bu işlem yaklaşık 3-5 dakika sürecek. Lütfen bekleyin...`
            });

      - name: Analyze and Fix Issue with Gemini (with verbose output)
        timeout-minutes: 10
        uses: google-github-actions/run-gemini-cli@main
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_debug: true  # Debug modunu aç
          prompt: |
            Sen deneyimli bir yazılım geliştiricisisin. MUTLAKA dosya değişiklikleri yap.
            
            **ZORUNLU GÖREV:** Aşağıdaki issue için kod değişiklikleri YAP
            
            Issue: "${{ github.event.issue.title }}"
            Açıklama: "${{ github.event.issue.body }}"
            
            **ADIMLAR (HEPSİNİ YAP):**
            
            1. **Önce mevcut dosyaları listele:**
            ```bash
            ls -la
            find . -name "*.js" -o -name "*.py" -o -name "*.html" -o -name "*.css" | head -10
            ```
            
            2. **Issue'yu anlayıp hangi dosyaların değiştirileceğini belirle**
            
            3. **MUTLAKA en az bir dosyada değişiklik yap:**
               - Eğer bug ise: dosyayı düzelt
               - Eğer feature ise: yeni kod ekle  
               - Eğer belirsizse: README.md'ye açıklama ekle
            
            4. **Değişiklik örnekleri:**
               - JavaScript hatası → .js dosyasını düzelt
               - CSS sorunu → .css dosyasını güncelle
               - Dokümantasyon → README.md güncelle
               - Python hatası → .py dosyasını düzelt
            
            5. **Her değişiklikten sonra dosyayı kaydet ve durumu kontrol et:**
            ```bash
            # Değişiklik yaptıktan sonra:
            git status
            git diff
            ls -la [değiştirdiğin-dosya]
            ```
            
            **ÖNEMLİ:** 
            - Hiçbir şey yapmadan bitirme!
            - En az 1 dosyada değişiklik yap!
            - Issue ile ilgili olmasa bile, küçük bir iyileştirme yap!
            
            **SON KONTROL:** İşlem bitiminde `git status` çalıştır ve değişiklikleri göster.

      - name: Show what changed (detailed)
        id: show_changes
        run: |
          echo "🔍 Değişiklik kontrolü yapılıyor..."
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "✅ DEĞİŞİKLİKLER BULUNDU!"
            echo "changes_made=true" >> $GITHUB_OUTPUT
            
            echo "📝 Değişen dosyalar:"
            git status --short
            
            echo ""
            echo "🔍 Detaylı değişiklikler:"
            git diff --name-only | while read file; do
              echo "📄 Dosya: $file"
              echo "➕➖ Değişiklik sayısı: +$(git diff --numstat "$file" | cut -f1) -$(git diff --numstat "$file" | cut -f2)"
            done
            
            echo ""
            echo "📊 Toplam değişiklik özeti:"
            git diff --stat
            
          else
            echo "❌ HİÇ DEĞİŞİKLİK YOK!"
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "⚠️  Gemini AI hiçbir dosyayı değiştirmedi."
          fi
          
      - name: Show file contents (if small changes)
        if: steps.show_changes.outputs.changes_made == 'true'
        run: |
          echo "📄 Değişen dosyaların içeriği:"
          git diff --name-only | head -3 | while read file; do
            echo "============ $file ============"
            if [ $(wc -l < "$file" 2>/dev/null || echo 999) -lt 50 ]; then
              echo "📝 Yeni içerik:"
              cat "$file" || echo "Dosya okunamadı"
            else
              echo "📝 Çok büyük dosya, sadece değişiklikleri gösteriliyor:"
              git diff "$file" | head -20
            fi
            echo ""
          done

      - name: Commit changes if any
        if: steps.show_changes.outputs.changes_made == 'true'
        run: |
          echo "💾 Değişiklikler commit ediliyor..."
          git add .
          git commit -m "🤖 fix: Issue #${{ github.event.issue.number }} - Gemini AI otomatik düzeltme

          - Issue: ${{ github.event.issue.title }}
          - Otomatik kod düzeltmesi yapıldı
          - Gemini AI tarafından generate edildi"
          
          echo "✅ Commit başarılı!"
          
      - name: Push changes and create PR
        if: steps.show_changes.outputs.changes_made == 'true'
        run: |
          echo "🚀 Branch push ediliyor..."
          git push origin "$BRANCH_NAME"
          echo "✅ Push başarılı!"
          
      - name: Create Pull Request
        if: steps.show_changes.outputs.changes_made == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "🤖 Auto-fix: ${{ github.event.issue.title }}"
          body: |
            ## 🤖 Gemini AI Otomatik Düzeltmesi
            
            Bu PR, **#${{ github.event.issue.number }}** numaralı issue için Gemini AI tarafından otomatik olarak oluşturulmuştur.
            
            ### 📋 Issue Detayları
            **Başlık:** ${{ github.event.issue.title }}
            **Açıklama:** ${{ github.event.issue.body }}
            **Link:** https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}
            
            ### 🔧 Yapılan Değişiklikler
            Gemini AI tarafından otomatik olarak kod değişiklikleri yapıldı.
            
            ### 📊 Değişiklik Özeti
            - Otomatik kod analizi ve düzeltme
            - Issue'da belirtilen problemin çözümü  
            - Mevcut kod stiline uygun güncellemeler
            
            ### ⚠️ İnceleme Listesi
            - [ ] Kod değişikliklerini inceleyin
            - [ ] Testlerin geçtiğini kontrol edin
            - [ ] Breaking changes olmadığını doğrulayın
            - [ ] Güvenlik açıklarının bulunmadığını kontrol edin
            
            ### 🔍 Değişiklikleri Görüntüleme
            ```bash
            # Bu branch'ı local'e çekin
            git checkout ${{ env.BRANCH_NAME }}
            
            # Değişiklikleri görün
            git diff main
            ```
            
            ---
            🤖 **AI Generated:** Bu değişiklikler tamamen AI tarafından yapılmıştır.
            📝 **Workflow Log:** [Detaylı işlem logları](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            Closes #${{ github.event.issue.number }}
          delete-branch: true
          
      - name: Comment on issue - SUCCESS
        if: steps.show_changes.outputs.changes_made == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ✅ Gemini AI Başarıyla Tamamlandı!
              
              🎉 **Durum:** Kod değişiklikleri yapıldı ve PR oluşturuldu!
              ⏰ **Tamamlanma:** ${new Date().toLocaleString('tr-TR')}
              
              ### 📋 Yapılanlar:
              ✅ Issue analiz edildi  
              ✅ Kod değişiklikleri yapıldı  
              ✅ Pull Request oluşturuldu  
              ✅ Branch: \`${{ env.BRANCH_NAME }}\`
              
              ### 🔍 Kontrol:
              📥 [Pull Request'i görüntüleyin](https://github.com/${{ github.repository }}/pulls)
              📊 [Detaylı log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              **Sonraki adım:** PR'ı inceleyin ve test edin! 🚀`
            });
            
      - name: Comment on issue - FAILED
        if: steps.show_changes.outputs.changes_made == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ Gemini AI Kod Değişikliği Yapamadı
              
              ⏰ **Tamamlanma:** ${new Date().toLocaleString('tr-TR')}
              🔍 **Durum:** Issue analiz edildi ancak kod değişikliği yapılamadı
              
              ### 🤔 Olası nedenler:
              - Issue belirsiz veya daha fazla detay gerektiriyor
              - Otomatik düzeltme yapılamayan karmaşık bir problem  
              - Repository yapısı tanımlanamadı
              - Gemini API geçici olarak yanıt vermedi
              
              ### 💡 Öneriler:
              1. Issue'yu daha detaylı açıklayın
              2. Hangi dosyaların etkilendiğini belirtin  
              3. Beklenen davranışı net bir şekilde tanımlayın
              4. Hata mesajları varsa ekleyin
              
              ### 🔍 Debug:
              📊 [İşlem detaylarına bakın](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              Tekrar denemek için issue'yu düzenleyebilir veya yorum ekleyebilirsiniz.`
            });