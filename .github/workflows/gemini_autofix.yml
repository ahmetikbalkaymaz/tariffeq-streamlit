name: Gemini AI Auto Code Fixer

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # 15 dakika timeout
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Git
        run: |
          git config --global user.name "Gemini AI Bot"
          git config --global user.email "gemini-ai@github-actions.local"
          
      - name: Create working branch
        run: |
          BRANCH_NAME="gemini-fix-${{ github.event.issue.number }}-$(date +%s)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b "$BRANCH_NAME"
          
      - name: Show initial status
        run: |
          echo "ğŸš€ Ä°ÅŸlem baÅŸlatÄ±lÄ±yor..."
          echo "ğŸ“ Mevcut dosyalar:"
          find . -name "*.js" -o -name "*.py" -o -name "*.css" -o -name "*.html" -o -name "*.md" | head -10
          echo "ğŸ“Š Toplam kod dosyasÄ±: $(find . -name "*.js" -o -name "*.py" -o -name "*.css" -o -name "*.html" | wc -l)"
          
      - name: Comment on issue - Starting
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Gemini AI Ä°ÅŸlem BaÅŸlatÄ±ldÄ±
              
              â° **BaÅŸlangÄ±Ã§:** ${new Date().toLocaleString('tr-TR')}
              ğŸ” **Durum:** Issue analiz ediliyor ve kod deÄŸiÅŸiklikleri yapÄ±lÄ±yor...
              ğŸ“Š **Workflow:** [DetaylÄ± log iÃ§in tÄ±klayÄ±n](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ğŸ’¡ Bu iÅŸlem yaklaÅŸÄ±k 3-5 dakika sÃ¼recek. LÃ¼tfen bekleyin...`
            });

      - name: Analyze and Fix Issue with Gemini (with verbose output)
        timeout-minutes: 10
        uses: google-github-actions/run-gemini-cli@main
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_debug: true  # Debug modunu aÃ§
          prompt: |
            Sen deneyimli bir yazÄ±lÄ±m geliÅŸtiricisisin. MUTLAKA dosya deÄŸiÅŸiklikleri yap.
            
            **ZORUNLU GÃ–REV:** AÅŸaÄŸÄ±daki issue iÃ§in kod deÄŸiÅŸiklikleri YAP
            
            Issue: "${{ github.event.issue.title }}"
            AÃ§Ä±klama: "${{ github.event.issue.body }}"
            
            **ADIMLAR (HEPSÄ°NÄ° YAP):**
            
            1. **Ã–nce mevcut dosyalarÄ± listele:**
            ```bash
            ls -la
            find . -name "*.js" -o -name "*.py" -o -name "*.html" -o -name "*.css" | head -10
            ```
            
            2. **Issue'yu anlayÄ±p hangi dosyalarÄ±n deÄŸiÅŸtirileceÄŸini belirle**
            
            3. **MUTLAKA en az bir dosyada deÄŸiÅŸiklik yap:**
               - EÄŸer bug ise: dosyayÄ± dÃ¼zelt
               - EÄŸer feature ise: yeni kod ekle  
               - EÄŸer belirsizse: README.md'ye aÃ§Ä±klama ekle
            
            4. **DeÄŸiÅŸiklik Ã¶rnekleri:**
               - JavaScript hatasÄ± â†’ .js dosyasÄ±nÄ± dÃ¼zelt
               - CSS sorunu â†’ .css dosyasÄ±nÄ± gÃ¼ncelle
               - DokÃ¼mantasyon â†’ README.md gÃ¼ncelle
               - Python hatasÄ± â†’ .py dosyasÄ±nÄ± dÃ¼zelt
            
            5. **Her deÄŸiÅŸiklikten sonra dosyayÄ± kaydet ve durumu kontrol et:**
            ```bash
            # DeÄŸiÅŸiklik yaptÄ±ktan sonra:
            git status
            git diff
            ls -la [deÄŸiÅŸtirdiÄŸin-dosya]
            ```
            
            **Ã–NEMLÄ°:** 
            - HiÃ§bir ÅŸey yapmadan bitirme!
            - En az 1 dosyada deÄŸiÅŸiklik yap!
            - Issue ile ilgili olmasa bile, kÃ¼Ã§Ã¼k bir iyileÅŸtirme yap!
            
            **SON KONTROL:** Ä°ÅŸlem bitiminde `git status` Ã§alÄ±ÅŸtÄ±r ve deÄŸiÅŸiklikleri gÃ¶ster.

      - name: Show what changed (detailed)
        id: show_changes
        run: |
          echo "ğŸ” DeÄŸiÅŸiklik kontrolÃ¼ yapÄ±lÄ±yor..."
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "âœ… DEÄÄ°ÅÄ°KLÄ°KLER BULUNDU!"
            echo "changes_made=true" >> $GITHUB_OUTPUT
            
            echo "ğŸ“ DeÄŸiÅŸen dosyalar:"
            git status --short
            
            echo ""
            echo "ğŸ” DetaylÄ± deÄŸiÅŸiklikler:"
            git diff --name-only | while read file; do
              echo "ğŸ“„ Dosya: $file"
              echo "â•â– DeÄŸiÅŸiklik sayÄ±sÄ±: +$(git diff --numstat "$file" | cut -f1) -$(git diff --numstat "$file" | cut -f2)"
            done
            
            echo ""
            echo "ğŸ“Š Toplam deÄŸiÅŸiklik Ã¶zeti:"
            git diff --stat
            
          else
            echo "âŒ HÄ°Ã‡ DEÄÄ°ÅÄ°KLÄ°K YOK!"
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Gemini AI hiÃ§bir dosyayÄ± deÄŸiÅŸtirmedi."
          fi
          
      - name: Show file contents (if small changes)
        if: steps.show_changes.outputs.changes_made == 'true'
        run: |
          echo "ğŸ“„ DeÄŸiÅŸen dosyalarÄ±n iÃ§eriÄŸi:"
          git diff --name-only | head -3 | while read file; do
            echo "============ $file ============"
            if [ $(wc -l < "$file" 2>/dev/null || echo 999) -lt 50 ]; then
              echo "ğŸ“ Yeni iÃ§erik:"
              cat "$file" || echo "Dosya okunamadÄ±"
            else
              echo "ğŸ“ Ã‡ok bÃ¼yÃ¼k dosya, sadece deÄŸiÅŸiklikleri gÃ¶steriliyor:"
              git diff "$file" | head -20
            fi
            echo ""
          done

      - name: Commit changes if any
        if: steps.show_changes.outputs.changes_made == 'true'
        run: |
          echo "ğŸ’¾ DeÄŸiÅŸiklikler commit ediliyor..."
          git add .
          git commit -m "ğŸ¤– fix: Issue #${{ github.event.issue.number }} - Gemini AI otomatik dÃ¼zeltme

          - Issue: ${{ github.event.issue.title }}
          - Otomatik kod dÃ¼zeltmesi yapÄ±ldÄ±
          - Gemini AI tarafÄ±ndan generate edildi"
          
          echo "âœ… Commit baÅŸarÄ±lÄ±!"
          
      - name: Push changes and create PR
        if: steps.show_changes.outputs.changes_made == 'true'
        run: |
          echo "ğŸš€ Branch push ediliyor..."
          git push origin "$BRANCH_NAME"
          echo "âœ… Push baÅŸarÄ±lÄ±!"
          
      - name: Create Pull Request
        if: steps.show_changes.outputs.changes_made == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "ğŸ¤– Auto-fix: ${{ github.event.issue.title }}"
          body: |
            ## ğŸ¤– Gemini AI Otomatik DÃ¼zeltmesi
            
            Bu PR, **#${{ github.event.issue.number }}** numaralÄ± issue iÃ§in Gemini AI tarafÄ±ndan otomatik olarak oluÅŸturulmuÅŸtur.
            
            ### ğŸ“‹ Issue DetaylarÄ±
            **BaÅŸlÄ±k:** ${{ github.event.issue.title }}
            **AÃ§Ä±klama:** ${{ github.event.issue.body }}
            **Link:** https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}
            
            ### ğŸ”§ YapÄ±lan DeÄŸiÅŸiklikler
            Gemini AI tarafÄ±ndan otomatik olarak kod deÄŸiÅŸiklikleri yapÄ±ldÄ±.
            
            ### ğŸ“Š DeÄŸiÅŸiklik Ã–zeti
            - Otomatik kod analizi ve dÃ¼zeltme
            - Issue'da belirtilen problemin Ã§Ã¶zÃ¼mÃ¼  
            - Mevcut kod stiline uygun gÃ¼ncellemeler
            
            ### âš ï¸ Ä°nceleme Listesi
            - [ ] Kod deÄŸiÅŸikliklerini inceleyin
            - [ ] Testlerin geÃ§tiÄŸini kontrol edin
            - [ ] Breaking changes olmadÄ±ÄŸÄ±nÄ± doÄŸrulayÄ±n
            - [ ] GÃ¼venlik aÃ§Ä±klarÄ±nÄ±n bulunmadÄ±ÄŸÄ±nÄ± kontrol edin
            
            ### ğŸ” DeÄŸiÅŸiklikleri GÃ¶rÃ¼ntÃ¼leme
            ```bash
            # Bu branch'Ä± local'e Ã§ekin
            git checkout ${{ env.BRANCH_NAME }}
            
            # DeÄŸiÅŸiklikleri gÃ¶rÃ¼n
            git diff main
            ```
            
            ---
            ğŸ¤– **AI Generated:** Bu deÄŸiÅŸiklikler tamamen AI tarafÄ±ndan yapÄ±lmÄ±ÅŸtÄ±r.
            ğŸ“ **Workflow Log:** [DetaylÄ± iÅŸlem loglarÄ±](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            Closes #${{ github.event.issue.number }}
          delete-branch: true
          
      - name: Comment on issue - SUCCESS
        if: steps.show_changes.outputs.changes_made == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Gemini AI BaÅŸarÄ±yla TamamlandÄ±!
              
              ğŸ‰ **Durum:** Kod deÄŸiÅŸiklikleri yapÄ±ldÄ± ve PR oluÅŸturuldu!
              â° **Tamamlanma:** ${new Date().toLocaleString('tr-TR')}
              
              ### ğŸ“‹ YapÄ±lanlar:
              âœ… Issue analiz edildi  
              âœ… Kod deÄŸiÅŸiklikleri yapÄ±ldÄ±  
              âœ… Pull Request oluÅŸturuldu  
              âœ… Branch: \`${{ env.BRANCH_NAME }}\`
              
              ### ğŸ” Kontrol:
              ğŸ“¥ [Pull Request'i gÃ¶rÃ¼ntÃ¼leyin](https://github.com/${{ github.repository }}/pulls)
              ğŸ“Š [DetaylÄ± log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              **Sonraki adÄ±m:** PR'Ä± inceleyin ve test edin! ğŸš€`
            });
            
      - name: Comment on issue - FAILED
        if: steps.show_changes.outputs.changes_made == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Gemini AI Kod DeÄŸiÅŸikliÄŸi YapamadÄ±
              
              â° **Tamamlanma:** ${new Date().toLocaleString('tr-TR')}
              ğŸ” **Durum:** Issue analiz edildi ancak kod deÄŸiÅŸikliÄŸi yapÄ±lamadÄ±
              
              ### ğŸ¤” OlasÄ± nedenler:
              - Issue belirsiz veya daha fazla detay gerektiriyor
              - Otomatik dÃ¼zeltme yapÄ±lamayan karmaÅŸÄ±k bir problem  
              - Repository yapÄ±sÄ± tanÄ±mlanamadÄ±
              - Gemini API geÃ§ici olarak yanÄ±t vermedi
              
              ### ğŸ’¡ Ã–neriler:
              1. Issue'yu daha detaylÄ± aÃ§Ä±klayÄ±n
              2. Hangi dosyalarÄ±n etkilendiÄŸini belirtin  
              3. Beklenen davranÄ±ÅŸÄ± net bir ÅŸekilde tanÄ±mlayÄ±n
              4. Hata mesajlarÄ± varsa ekleyin
              
              ### ğŸ” Debug:
              ğŸ“Š [Ä°ÅŸlem detaylarÄ±na bakÄ±n](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              Tekrar denemek iÃ§in issue'yu dÃ¼zenleyebilir veya yorum ekleyebilirsiniz.`
            });