name: Gemini AI Developer

on:
  issues:
    types: [opened, edited] # Triggers on new or edited issues
  issue_comment:
    types: [created] # Triggers on a new issue comment

jobs:
  build-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup gcloud CLI
        # Corrected the version from @v0.1.9 to a valid major version
        uses: google-github-actions/setup-gcloud@v0
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }} # Optional: If using GCP services
          service_account_key: ${{ secrets.GCP_SA_KEY }} # Optional: For secure authentication

      - name: Run Gemini CLI on Issue
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          command: |
            # Get the issue title and body
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
            
            # Explain the task to Gemini
            echo "Fix the error described in the following GitHub issue or add the requested feature. Make the necessary code changes and list only the modified files." > prompt.txt
            echo "Issue Title: $ISSUE_TITLE" >> prompt.txt
            echo "Issue Description: $ISSUE_BODY" >> prompt.txt
            
            # Run the Gemini CLI
            gemini -p prompt.txt --write

      - name: Create Pull Request
        if: steps.gemini.outputs.result == 'success' # If Gemini successfully made changes
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(ai): Automated fix for issue #${{ github.event.issue.number }} by Gemini"
          title: "AI Fix for: ${{ github.event.issue.title }}"
          body: |
            This pull request was automatically generated by Gemini to resolve issue #${{ github.event.issue.number }}.

            Please review and approve the changes.
          branch: "gemini-fix-${{ github.event.issue.number }}"
          base: main # Specify your main branch name here