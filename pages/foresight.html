<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yangƒ±n Verisi Haritasƒ±</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        #app {
            display: flex;
            height: 100vh;
        }

        #map {
            flex-grow: 1;
            height: 100%;
        }

        #sidebar {
            width: 380px;
            min-width: 320px;
            height: 100%;
            background-color: #f8fafc;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100">

    <div id="app">
        <aside id="sidebar" class="p-6 space-y-6">
            <header>
                <h1 class="text-2xl font-bold text-gray-800">Orman Yangƒ±nƒ± Bilgi Sistemi</h1>
                <p class="text-sm text-gray-500">Veritabanƒ± Entegreli G√∂rselle≈ütirme</p>
            </header>

            <div class="space-y-2">
                <label for="coord-search" class="block font-medium text-gray-700">Koordinat ile Ara</label>
                <div class="flex space-x-2">
                    <input type="text" id="coord-search" placeholder="√ñrn: 38.42, 27.14"
                        class="block w-full px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">

                    <button id="search-btn"
                        class="p-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        title="Ara">üîç</button>

                    <button id="select-on-map-btn"
                        class="p-2 font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                        title="Haritadan Konum Se√ß">üìç</button>
                </div>
                <p class="text-xs text-gray-500">Enlem ve boylam arasƒ±na virg√ºl koyarak arama yapƒ±nƒ±z.</p>
            </div>

            <div id="ai-analysis-section" class="space-y-4 pt-4 border-t">
                <h2 class="text-lg font-semibold text-gray-800">‚ú® AI Destekli Risk Analizi</h2>
                <div id="fire-details" class="bg-gray-50 p-4 rounded-lg text-sm text-gray-600">Analiz i√ßin haritadan bir
                    yangƒ±n alanƒ± se√ßin veya koordinat belirleyin.</div>
                <div id="gemini-result"
                    class="text-sm text-gray-700 leading-relaxed p-4 border rounded-lg bg-white hidden"></div>
                <div id="gemini-loader" class="flex items-center justify-center p-4 hidden">
                    <div class="loader"></div>
                    <p class="ml-3 text-gray-600">Analiz olu≈üturuluyor...</p>
                </div>
            </div>
        </aside>
        <main id="map"></main>
    </div>

    <script>
        // --- UYGULAMA BA≈ûLANGICI ---

        // Proj4 kontrol√º (Hata √∂nleyici)
        if (typeof proj4 === 'undefined') {
            alert("Harita k√ºt√ºphanesi (Proj4) y√ºklenemedi. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin veya sayfayƒ± yenileyin.");
        }

        const map = L.map('map').setView([39.0, 35.0], 6);
        let allFireData = [];
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const fireDetailsContainer = document.getElementById('fire-details');
        const geminiResultContainer = document.getElementById('gemini-result');
        const geminiLoader = document.getElementById('gemini-loader');

        function loadAndProcessData() {
            // Projeksiyon Tanƒ±mlarƒ±
            const crs3035 = '+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs';
            const crs4326 = 'EPSG:4326';

            // Veriyi al
            const allFeatures = __VERI_BURAYA_GELECEK__;

            try {
                if (!allFeatures || allFeatures.length === 0) {
                    throw new Error("Veri bo≈ü geldi.");
                }

                allFeatures.forEach(feature => {
                    const { properties, geometry } = feature;
                    const alan = properties.area_ha;
                    const initialDate = new Date(properties.initialdate);
                    const formattedDate = initialDate.toLocaleDateString('tr-TR');

                    if (geometry && geometry.type === "MultiPolygon" && alan > 0) {
                        const polygonCoords = geometry.coordinates[0][0];

                        const latLngs = polygonCoords.map(coord => {
                            const converted = proj4(crs3035, crs4326, coord);
                            return [converted[1], converted[0]];
                        });

                        const polygon = L.polygon(latLngs, {
                            color: 'red', fillColor: '#f03', fillOpacity: 0.5, weight: 1
                        }).addTo(map);

                        polygon.bindPopup(`<b>Yangƒ±n Alanƒ±</b><br>B√∂lge: ${properties.admlvl1 || 'Bilinmiyor'}<br>Alan: ${alan.toFixed(2)} ha<br>Tarih: ${formattedDate}`);

                        const center = polygon.getBounds().getCenter();
                        allFireData.push({ center: center, properties: properties });

                        polygon.on('click', () => {
                            geminiResultContainer.classList.add('hidden');
                            fireDetailsContainer.innerHTML = `
                                <p><strong>Se√ßilen Yangƒ±n</strong></p>
                                <p>B√∂lge: ${properties.admlvl1 || '-'}</p>
                                <p>Alan: ${alan.toFixed(2)} ha</p>
                                <p>Tarih: ${formattedDate}</p>
                                <button id="analyze-btn" class="w-full mt-3 px-4 py-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">‚ú® Analiz Et</button>
                            `;
                            document.getElementById('analyze-btn').addEventListener('click', () =>
                                getAnalysis('polygon', { lat: center.lat, lon: center.lng, area: alan })
                            );
                        });
                    }
                });
            } catch (error) {
                console.error("Veri i≈üleme hatasƒ±:", error);
                fireDetailsContainer.innerHTML = `<p class="text-red-600">Veri hatasƒ±: ${error.message}</p>`;
            }
        }

        // --- Risk Skorlama ---
        function calculateRiskScore(lat, lon) {
            const point = L.latLng(lat, lon);
            let totalThreatScore = 0;
            const MAX_DISTANCE_KM = 20;
            allFireData.forEach(fire => {
                const distanceMeters = point.distanceTo(fire.center);
                const distanceKm = distanceMeters / 1000;
                if (distanceKm < MAX_DISTANCE_KM) {
                    const area = fire.properties.area_ha || 1;
                    const effectiveDistance = Math.max(distanceKm, 0.1);
                    totalThreatScore += (area / (effectiveDistance * effectiveDistance));
                }
            });
            if (totalThreatScore > 200) return 5;
            if (totalThreatScore > 50) return 4;
            if (totalThreatScore > 10) return 3;
            if (totalThreatScore > 1) return 2;
            return 1;
        }

        // --- Gemini API ---
        async function getAnalysis(type, data) {
            const btn = document.getElementById("analyze-btn");
            if (btn) { btn.disabled = true; btn.textContent = 'Analiz Yapƒ±lƒ±yor...'; }

            geminiLoader.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');

            const apiKey = "__GEMINI_API_KEY__";
            // Model: gemini-2.5-flash-lite
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;

            let prompt = type === 'coordinate'
                ? `Konum (${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}). Risk Skoru: ${calculateRiskScore(data.lat, data.lon)}/5. Yangƒ±n riskini 3 c√ºmleyle √∂zetle.`
                : `Bu konumda (${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}) daha √∂nce ${data.area.toFixed(2)} hektar yandƒ±. Gelecek riskini 3 c√ºmleyle anlat.`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (response.status === 429) throw new Error("√áok fazla istek (429). Bekleyin.");
                if (!response.ok) throw new Error(`API Hatasƒ±: ${response.status}`);

                const result = await response.json();
                geminiResultContainer.textContent = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Yanƒ±t alƒ±namadƒ±.';
            } catch (error) {
                geminiResultContainer.textContent = 'Hata: ' + error.message;
            } finally {
                geminiLoader.classList.add('hidden');
                geminiResultContainer.classList.remove('hidden');
                if (btn) { btn.disabled = false; btn.textContent = '‚ú® Risk Analizi Olu≈ütur'; }
            }
        }

        // --- Arama ve Konum Se√ßme Fonksiyonlarƒ± ---

        // 1. Arama Mantƒ±ƒüƒ±nƒ± Fonksiyona √áevirdik (Hem butondan hem haritadan tetiklenebilsin diye)
        let searchMarker = null;
        function performSearch() {
            const val = document.getElementById('coord-search').value;
            if (!val) return;
            const parts = val.split(',').map(p => parseFloat(p.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                const [lat, lon] = parts;
                map.setView([lat, lon], 13);

                if (searchMarker) map.removeLayer(searchMarker);
                searchMarker = L.marker([lat, lon]).addTo(map).bindPopup("Se√ßilen Konum").openPopup();

                geminiResultContainer.classList.add('hidden');
                fireDetailsContainer.innerHTML = `
                    <p><strong>Se√ßilen Konum</strong></p>
                    <p>${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
                    <button id="analyze-btn" class="w-full mt-3 px-4 py-2 bg-indigo-600 text-white rounded font-semibold hover:bg-indigo-700">‚ú® Analiz Et</button>
                `;
                document.getElementById('analyze-btn').addEventListener('click', () => getAnalysis('coordinate', { lat, lon }));
            }
        }

        // 2. Arama Butonu Tƒ±klamasƒ±
        document.getElementById('search-btn').addEventListener('click', performSearch);

        // 3. Enter Tu≈üu Desteƒüi
        document.getElementById('coord-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        // 4. Haritadan Konum Se√ßme √ñzelliƒüi (AKTARIILDI)
        const selectOnMapBtn = document.getElementById('select-on-map-btn');
        selectOnMapBtn.addEventListener('click', () => {
            const mapContainer = document.getElementById('map');

            // G√∂rsel Geri Bildirim
            mapContainer.style.cursor = 'crosshair';
            selectOnMapBtn.disabled = true;
            selectOnMapBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // Tek seferlik tƒ±klama dinleyicisi
            map.once('click', (e) => {
                const { lat, lng } = e.latlng;

                // Input'a yaz
                document.getElementById('coord-search').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

                // Aramayƒ± otomatik tetikle (Marker koyar, paneli g√ºnceller)
                performSearch();

                // Eski haline getir
                mapContainer.style.cursor = '';
                selectOnMapBtn.disabled = false;
                selectOnMapBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        });

        loadAndProcessData();
    </script>
</body>

</html>

<!-- 

<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yangƒ±n Verisi Haritasƒ±</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        #app {
            display: flex;
            height: 100vh;
        }

        #map {
            flex-grow: 1;
            height: 100%;
        }

        #sidebar {
            width: 380px;
            min-width: 320px;
            height: 100%;
            background-color: #f8fafc;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100">

    <div id="app">
        <aside id="sidebar" class="p-6 space-y-6">
            <header>
                <h1 class="text-2xl font-bold text-gray-800">Orman Yangƒ±nƒ± Bilgi Sistemi</h1>
                <p class="text-sm text-gray-500">Veritabanƒ± Entegreli G√∂rselle≈ütirme</p>
            </header>

            <div class="space-y-2">
                <label for="coord-search" class="block font-medium text-gray-700">Koordinat ile Ara</label>
                <div class="flex space-x-2">
                    <input type="text" id="coord-search" placeholder="√ñrn: 38.42, 27.14"
                        class="block w-full px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <button id="search-btn"
                        class="p-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        title="Ara">üîç</button>
                </div>
            </div>

            <div id="ai-analysis-section" class="space-y-4 pt-4 border-t">
                <h2 class="text-lg font-semibold text-gray-800">‚ú® AI Destekli Risk Analizi</h2>
                <div id="fire-details" class="bg-gray-50 p-4 rounded-lg text-sm text-gray-600">Analiz i√ßin haritadan bir
                    yangƒ±n alanƒ± se√ßin.</div>
                <div id="gemini-result"
                    class="text-sm text-gray-700 leading-relaxed p-4 border rounded-lg bg-white hidden"></div>
                <div id="gemini-loader" class="flex items-center justify-center p-4 hidden">
                    <div class="loader"></div>
                    <p class="ml-3 text-gray-600">Analiz olu≈üturuluyor...</p>
                </div>
            </div>
        </aside>
        <main id="map"></main>
    </div>

    <script>
        // --- UYGULAMA BA≈ûLANGICI ---

        // Proj4 kontrol√º (Hata √∂nleyici)
        if (typeof proj4 === 'undefined') {
            alert("Harita k√ºt√ºphanesi (Proj4) y√ºklenemedi. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin veya sayfayƒ± yenileyin.");
        }

        const map = L.map('map').setView([39.0, 35.0], 6);
        let allFireData = [];
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const fireDetailsContainer = document.getElementById('fire-details');
        const geminiResultContainer = document.getElementById('gemini-result');
        const geminiLoader = document.getElementById('gemini-loader');

        function loadAndProcessData() {
            // Projeksiyon Tanƒ±mlarƒ±
            const crs3035 = '+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs';
            const crs4326 = 'EPSG:4326';

            // Veriyi al
            const allFeatures = __VERI_BURAYA_GELECEK__;

            try {
                if (!allFeatures || allFeatures.length === 0) {
                    throw new Error("Veri bo≈ü geldi.");
                }

                allFeatures.forEach(feature => {
                    const { properties, geometry } = feature;
                    const alan = properties.area_ha;
                    const initialDate = new Date(properties.initialdate);
                    const formattedDate = initialDate.toLocaleDateString('tr-TR');

                    if (geometry && geometry.type === "MultiPolygon" && alan > 0) {
                        const polygonCoords = geometry.coordinates[0][0];

                        // KOORDƒ∞NAT D√ñN√ú≈û√úM√ú (Hata burada √ßƒ±kƒ±yordu)
                        const latLngs = polygonCoords.map(coord => {
                            // proj4 artƒ±k y√ºkl√º olduƒüu i√ßin hata vermeyecek
                            const converted = proj4(crs3035, crs4326, coord);
                            return [converted[1], converted[0]];
                        });

                        const polygon = L.polygon(latLngs, {
                            color: 'red', fillColor: '#f03', fillOpacity: 0.5, weight: 1
                        }).addTo(map);

                        polygon.bindPopup(`<b>Yangƒ±n Alanƒ±</b><br>B√∂lge: ${properties.admlvl1 || 'Bilinmiyor'}<br>Alan: ${alan.toFixed(2)} ha<br>Tarih: ${formattedDate}`);

                        const center = polygon.getBounds().getCenter();
                        allFireData.push({ center: center, properties: properties });

                        polygon.on('click', () => {
                            geminiResultContainer.classList.add('hidden');
                            fireDetailsContainer.innerHTML = `
                                <p><strong>Se√ßilen Yangƒ±n</strong></p>
                                <p>B√∂lge: ${properties.admlvl1 || '-'}</p>
                                <p>Alan: ${alan.toFixed(2)} ha</p>
                                <p>Tarih: ${formattedDate}</p>
                                <button id="analyze-btn" class="w-full mt-3 px-4 py-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">‚ú® Analiz Et</button>
                            `;
                            document.getElementById('analyze-btn').addEventListener('click', () =>
                                getAnalysis('polygon', { lat: center.lat, lon: center.lng, area: alan })
                            );
                        });
                    }
                });
            } catch (error) {
                console.error("Veri i≈üleme hatasƒ±:", error);
                fireDetailsContainer.innerHTML = `<p class="text-red-600">Veri hatasƒ±: ${error.message}</p>`;
            }
        }

        // --- Risk Skorlama ---
        function calculateRiskScore(lat, lon) {
            const point = L.latLng(lat, lon);
            let totalThreatScore = 0;
            const MAX_DISTANCE_KM = 20;
            allFireData.forEach(fire => {
                const distanceMeters = point.distanceTo(fire.center);
                const distanceKm = distanceMeters / 1000;
                if (distanceKm < MAX_DISTANCE_KM) {
                    const area = fire.properties.area_ha || 1;
                    const effectiveDistance = Math.max(distanceKm, 0.1);
                    totalThreatScore += (area / (effectiveDistance * effectiveDistance));
                }
            });
            if (totalThreatScore > 200) return 5;
            if (totalThreatScore > 50) return 4;
            if (totalThreatScore > 10) return 3;
            if (totalThreatScore > 1) return 2;
            return 1;
        }

        // --- Gemini API ---
        async function getAnalysis(type, data) {
            const btn = document.getElementById("analyze-btn");
            if (btn) { btn.disabled = true; btn.textContent = 'Analiz Yapƒ±lƒ±yor...'; }

            geminiLoader.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');

            const apiKey = "__GEMINI_API_KEY__";
            // Model: gemini-2.0-flash-lite
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;

            let prompt = type === 'coordinate'
                ? `Konum (${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}). Risk Skoru: ${calculateRiskScore(data.lat, data.lon)}/5. Yangƒ±n riskini 3 c√ºmleyle √∂zetle.`
                : `Bu konumda (${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}) daha √∂nce ${data.area.toFixed(2)} hektar yandƒ±. Gelecek riskini 3 c√ºmleyle anlat.`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (response.status === 429) throw new Error("√áok fazla istek (429). Bekleyin.");
                if (!response.ok) throw new Error(`API Hatasƒ±: ${response.status}`);

                const result = await response.json();
                geminiResultContainer.textContent = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Yanƒ±t alƒ±namadƒ±.';
            } catch (error) {
                geminiResultContainer.textContent = 'Hata: ' + error.message;
            } finally {
                geminiLoader.classList.add('hidden');
                geminiResultContainer.classList.remove('hidden');
                if (btn) { btn.disabled = false; btn.textContent = '‚ú® Risk Analizi Olu≈ütur'; }
            }
        }

        // Arama ƒ∞≈ülevi
        document.getElementById('search-btn').addEventListener('click', () => {
            const val = document.getElementById('coord-search').value;
            if (!val) return;
            const parts = val.split(',').map(p => parseFloat(p.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                const [lat, lon] = parts;
                map.setView([lat, lon], 13);
                L.marker([lat, lon]).addTo(map).bindPopup("Aranan Konum").openPopup();
                fireDetailsContainer.innerHTML = `<button id="analyze-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded">Analiz Et</button>`;
                document.getElementById('analyze-btn').addEventListener('click', () => getAnalysis('coordinate', { lat, lon }));
            }
        });

        loadAndProcessData();
    </script>
</body>

</html> -->