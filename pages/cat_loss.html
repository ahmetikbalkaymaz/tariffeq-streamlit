<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yapay Zeka Destekli NAT CAT Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            overflow: hidden;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            grid-template-rows: 1fr;
            height: calc(100vh - 120px);
            gap: 1rem;
        }
        #incident-list-container, #main-content-area {
            overflow-y: auto;
            height: 100%;
        }
        .active-item {
            background-color: #eef2ff;
            border-left-color: #4f46e5;
            transform: translateX(-4px);
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 10;
        }
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a3a3a3; }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="flex flex-col h-screen">
        <header class="bg-white shadow-sm w-full p-4 z-20 flex-shrink-0">
            <div class="max-w-screen-2xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Yapay Zeka Destekli NAT CAT Paneli</h1>
                        <p class="text-sm text-gray-500">TÃ¼rkiye: Son 3 AylÄ±k Orman YangÄ±nÄ± & Sel Analizi</p>
                    </div>
                </div>
            </div>
        </header>

        <div class="bg-white/80 backdrop-blur-sm w-full p-3 shadow-md z-10 flex-shrink-0">
            <div class="max-w-screen-2xl mx-auto flex flex-col md:flex-row gap-2 items-center">
                 <p class="font-semibold text-gray-600 mr-2">Filtreler:</p>
                 <select id="il-filter" class="w-full md:w-auto p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"><option value="all">TÃ¼m Ä°ller</option></select>
                 <select id="tehlike-filter" class="w-full md:w-auto p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"><option value="all">TÃ¼m Tehlike TÃ¼rleri</option></select>
                 <select id="etki-filter" class="w-full md:w-auto p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"><option value="all">TÃ¼m Etki Seviyeleri</option><option value="YÃ¼ksek">YÃ¼ksek</option><option value="Orta">Orta</option><option value="DÃ¼ÅŸÃ¼k">DÃ¼ÅŸÃ¼k</option></select>
                 <button id="reset-filters" class="w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md text-sm transition duration-150">Filtreleri Temizle</button>
                 <div id="result-count" class="ml-auto text-sm font-medium text-gray-600 pr-2"></div>
            </div>
        </div>

        <main class="max-w-screen-2xl mx-auto w-full p-4 flex-grow">
            <div class="main-grid">
                <aside id="incident-list-container" class="bg-white p-2 rounded-lg shadow-sm">
                    <h2 class="text-lg font-bold mb-3 p-2 border-b">Olay Listesi (En Yeni)</h2>
                    <div id="incident-list" class="space-y-1"></div>
                </aside>

                <div id="main-content-area">
                    <div id="details-panel" class="hidden bg-white p-6 rounded-lg shadow-lg"></div>
                    <div id="analysis-panel" class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        <div class="xl:col-span-2 h-[450px] bg-white rounded-lg shadow-lg p-4">
                             <h3 class="font-bold text-gray-700 text-lg mb-2">Afet KonumlarÄ± HaritasÄ±</h3>
                             <div id="map-container" class="w-full h-[calc(100%-40px)]"><div id="map"></div></div>
                        </div>
                        <div class="xl:col-span-2 bg-white rounded-lg shadow-lg p-4">
                             <div class="flex justify-between items-center mb-3">
                                 <h3 class="font-bold text-gray-700 text-lg">Ã–ne Ã‡Ä±kan Analizler</h3>
                                 <div class="flex gap-2">
                                     <button id="generate-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition duration-150 text-sm">ðŸ“Š DetaylÄ± Rapor GÃ¶rÃ¼ntÃ¼le</button>
                                     <button id="generate-analysis-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition duration-150 text-sm">âœ¨ Genel Risk Analizi Ä°ste</button>
                                 </div>
                             </div>
                             <div id="analysis-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-4">
                            <h3 class="font-semibold text-center mb-2 text-gray-600">Tehlike TÃ¼rÃ¼ne GÃ¶re Vaka SayÄ±sÄ±</h3>
                            <div class="chart-container"><canvas id="tehlikeChart"></canvas></div>
                        </div>
                         <div class="bg-white rounded-lg shadow-lg p-4">
                            <h3 class="font-semibold text-center mb-2 text-gray-600">Aylara GÃ¶re Vaka DaÄŸÄ±lÄ±mÄ±</h3>
                            <div class="chart-container"><canvas id="aylikChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="gemini-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 overflow-y-auto h-full w-full z-50 hidden flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-2xl bg-white transform transition-all duration-300 ease-out scale-95 opacity-0" id="gemini-modal-content-box">
             <div class="flex justify-between items-center mb-4 pb-3 border-b"><h3 class="text-xl leading-6 font-semibold text-gray-900 flex items-center gap-2" id="modal-title"></h3><button id="modal-close-btn-icon" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
             <div class="mt-2 px-2 py-3 max-h-[65vh] overflow-y-auto"><div id="modal-loading" class="hidden justify-center items-center py-10"><div class="spinner"></div><p class="ml-4 text-gray-600">Yapay zeka analiz ediyor...</p></div><div class="prose max-w-none text-gray-700" id="modal-content"></div></div>
             <div class="items-center px-4 py-3 mt-4 bg-gray-50 rounded-b-2xl"><button id="modal-close-btn" class="w-full px-4 py-2 bg-gray-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">Kapat</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            const incidentsData = [
                { id: "YanginHatay-ErzinGokdere2025-10-05", tarih: "05.10.2025", il: "Hatay", ilce: "Erzin", konum: "GÃ¶kdere mevkii", tehlikeTuru: "YangÄ±n", olayAdi: "Erzin Orman YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "Orta", yananAlanHa: 50, insaniEtki: "Belirtilmedi", maddiEtki: "OrmanlÄ±k alanda ve tarÄ±m arazilerinde hasar riski.", lat: 36.95, lng: 36.21, geometri: "Nokta", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "Hatay'Ä±n Erzin ilÃ§esi GÃ¶kdere mevkii yakÄ±nlarÄ±ndaki ormanlÄ±k alanda yangÄ±n Ã§Ä±ktÄ±. Ekiplerin havadan ve karadan mÃ¼dahalesi devam ediyor.", kaynaklar: [{kaynak: "Resmi AÃ§Ä±klama", alinti: "YangÄ±na mÃ¼dahale sÃ¼rÃ¼yor."}] },
                { id: "YanginBingol-GencDedebagi2025-10-05", tarih: "05.10.2025", il: "BingÃ¶l", ilce: "GenÃ§", konum: "DedebaÄŸÄ± kÃ¶yÃ¼ kÄ±rsalÄ±", tehlikeTuru: "YangÄ±n", olayAdi: "GenÃ§ KÄ±rsal Alan YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "DÃ¼ÅŸÃ¼k", yananAlanHa: 15, insaniEtki: "Belirtilmedi", maddiEtki: "SÄ±nÄ±rlÄ± alanda Ã¶rtÃ¼ yangÄ±nÄ±.", lat: 38.75, lng: 40.57, geometri: "Nokta", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "BingÃ¶l'Ã¼n GenÃ§ ilÃ§esi DedebaÄŸÄ± kÃ¶yÃ¼ kÄ±rsalÄ±nda Ã§Ä±kan Ã¶rtÃ¼ yangÄ±nÄ±, ekiplerin mÃ¼dahalesiyle kontrol altÄ±na alÄ±ndÄ±.", kaynaklar: [{kaynak: "Valilik", alinti: "YangÄ±n kontrol altÄ±na alÄ±ndÄ±."}] },
                { id: "YanginDiyarbakir-DicleBicer2025-10-04", tarih: "04.10.2025", il: "DiyarbakÄ±r", ilce: "Dicle", konum: "BiÃ§er Mahallesi", tehlikeTuru: "YangÄ±n", olayAdi: "Dicle KÄ±rsal YangÄ±nÄ±", sektor: "Orman/Ã–rtÃ¼", etkiSeviyesi: "Orta", yananAlanHa: 100, insaniEtki: "Belirtilmedi", maddiEtki: "GeniÅŸ bir alanda anÄ±z ve Ã¶rtÃ¼ yangÄ±nÄ±, tarÄ±m arazileri risk altÄ±nda.", lat: 38.37, lng: 40.06, geometri: "Ã‡okgen", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "DiyarbakÄ±r'Ä±n Dicle ilÃ§esi BiÃ§er Mahallesi'nde baÅŸlayan yangÄ±n geniÅŸ bir alana yayÄ±ldÄ±. YangÄ±nÄ±n anÄ±z yakma kaynaklÄ± olduÄŸu tahmin ediliyor.", kaynaklar: [{kaynak: "Yerel BasÄ±n", alinti: "YangÄ±n rÃ¼zgarÄ±n etkisiyle yayÄ±ldÄ±."}] },
                { id: "YanginKonya-KadinhaniKestel2025-10-04", tarih: "04.10.2025", il: "Konya", ilce: "KadÄ±nhanÄ±", konum: "Kestel OrmanÄ±", tehlikeTuru: "YangÄ±n", olayAdi: "Kestel Orman YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "DÃ¼ÅŸÃ¼k", yananAlanHa: 5, insaniEtki: "Belirtilmedi", maddiEtki: "Mesire alanÄ± yakÄ±nÄ±nda kÃ¼Ã§Ã¼k Ã§aplÄ± orman yangÄ±nÄ±.", lat: 38.24, lng: 32.21, geometri: "Nokta", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "Konya KadÄ±nhanÄ±'ndaki Kestel OrmanÄ± ve Mesire AlanÄ±'nda Ã§Ä±kan yangÄ±n, hÄ±zlÄ± mÃ¼dahale ile bÃ¼yÃ¼meden sÃ¶ndÃ¼rÃ¼ldÃ¼.", kaynaklar: [{kaynak: "OGM", alinti: "YangÄ±n sÃ¶ndÃ¼rÃ¼ldÃ¼."}] },
                { id: "YanginOsmaniye-MerkezZorkun2025-10-04", tarih: "04.10.2025", il: "Osmaniye", ilce: "Merkez", konum: "Zorkun YaylasÄ± yolu", tehlikeTuru: "YangÄ±n", olayAdi: "Zorkun YaylasÄ± YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "DÃ¼ÅŸÃ¼k", yananAlanHa: 2, insaniEtki: "Belirtilmedi", maddiEtki: "Yol kenarÄ±nda baÅŸlayan kÃ¼Ã§Ã¼k Ã§aplÄ± yangÄ±n.", lat: 37.05, lng: 36.25, geometri: "Nokta", dogrulamaYontemi: "B", dogrulukOrani: 90, ozet: "Zorkun YaylasÄ± yolu kenarÄ±nda bir araÃ§tan Ã§Ä±ktÄ±ÄŸÄ± iddia edilen yangÄ±n, bÃ¼yÃ¼meden kontrol altÄ±na alÄ±ndÄ±.", kaynaklar: [{kaynak: "Sosyal Medya", alinti: "GÃ¶rgÃ¼ tanÄ±klarÄ± yangÄ±nÄ±n araÃ§tan Ã§Ä±ktÄ±ÄŸÄ±nÄ± belirtti."}] },
                { id: "YanginKayseri-TalasCaybaglari2025-10-03", tarih: "03.10.2025", il: "Kayseri", ilce: "Talas", konum: "Ã‡aybaÄŸlarÄ± mevkii", tehlikeTuru: "YangÄ±n", olayAdi: "Talas Orman YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "DÃ¼ÅŸÃ¼k", yananAlanHa: 3, insaniEtki: "Belirtilmedi", maddiEtki: "Ä°hmal sonucu Ã§Ä±ktÄ±ÄŸÄ± dÃ¼ÅŸÃ¼nÃ¼len kÃ¼Ã§Ã¼k Ã§aplÄ± yangÄ±n.", lat: 38.68, lng: 35.59, geometri: "Nokta", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "Kayseri Talas'ta ihmal sonucu Ã§Ä±ktÄ±ÄŸÄ± tahmin edilen orman yangÄ±nÄ±, ekiplerce sÃ¶ndÃ¼rÃ¼ldÃ¼.", kaynaklar: [{kaynak: "OGM", alinti: "SoÄŸutma Ã§alÄ±ÅŸmalarÄ± tamamlandÄ±."}] },
                { id: "YanginGumushane-KelkitAlicyeri2025-09-29", tarih: "29.09.2025", il: "GÃ¼mÃ¼ÅŸhane", ilce: "Kelkit", konum: "AlÄ±Ã§yeri mevkii", tehlikeTuru: "YangÄ±n", olayAdi: "Kelkit Orman YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "DÃ¼ÅŸÃ¼k", yananAlanHa: 3, insaniEtki: "Belirtilmedi", maddiEtki: "YaklaÅŸÄ±k 30 dÃ¶nÃ¼m (3 hektar) alan zarar gÃ¶rdÃ¼.", lat: 40.09, lng: 39.27, geometri: "Nokta", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "GÃ¼mÃ¼ÅŸhane Kelkit'te Ã§Ä±kan orman yangÄ±nÄ±nda yaklaÅŸÄ±k 30 dÃ¶nÃ¼m alanÄ±n zarar gÃ¶rdÃ¼ÄŸÃ¼ bildirildi.", kaynaklar: [{kaynak: "AA", alinti: "YaklaÅŸÄ±k 30 dÃ¶nÃ¼m alan yandÄ±."}] },
                { id: "SelRize-MerkezMultiple2025-09-21", tarih: "21.09.2025", il: "Rize", ilce: "Merkez", konum: "Ä°l geneli", tehlikeTuru: "Sel", olayAdi: "Rize Sel Felaketi", sektor: "AltyapÄ±/Enerji", etkiSeviyesi: "YÃ¼ksek", yananAlanHa: 0, insaniEtki: "Belirtilmedi", maddiEtki: "KÃ¶y yollarÄ± ve altyapÄ±da hasar. MuratlÄ± BarajÄ± ve HES'in selden etkilendiÄŸi ve operasyonel riskler taÅŸÄ±dÄ±ÄŸÄ± bildirildi.", lat: 41.02, lng: 40.52, geometri: "Ã‡okgen", dogrulamaYontemi: "A", dogrulukOrani: 96, ozet: "Rize genelinde etkili olan ÅŸiddetli yaÄŸÄ±ÅŸlar sel ve heyelanlara neden oldu. Ã‡ok sayÄ±da kÃ¶y yolu ulaÅŸÄ±ma kapandÄ±. MuratlÄ± BarajÄ± ve HES'in de risk altÄ±nda olduÄŸu belirtildi.", kaynaklar: [{kaynak: "AFAD", alinti: "BÃ¶lgeye Ã§ok sayÄ±da ekip sevk edildi."}], etkilenenTesislerDetay: [{ad: "MuratlÄ± BarajÄ± ve HES", lat: 41.47, lng: 41.77, sektor: "Enerji" }] },
                { id: "SelTrabzon-MerkezMultiple2025-09-21", tarih: "21.09.2025", il: "Trabzon", ilce: "Merkez", konum: "Ä°l geneli", tehlikeTuru: "Sel", olayAdi: "Trabzon Sel Felaketi", sektor: "AltyapÄ±", etkiSeviyesi: "Orta", yananAlanHa: 0, insaniEtki: "Belirtilmedi", maddiEtki: "Åžehir merkezi ve ilÃ§elerde su baskÄ±nlarÄ±, altyapÄ± hasarÄ±.", lat: 41.00, lng: 39.72, geometri: "Ã‡okgen", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "Trabzon'da etkili olan saÄŸanak yaÄŸÄ±ÅŸ sele neden oldu, dereler taÅŸtÄ±.", kaynaklar: [{kaynak: "Valilik", alinti: "Hasar tespit Ã§alÄ±ÅŸmalarÄ± baÅŸladÄ±."}] },
                { id: "SelArtvin-BorckaKopru2025-09-21", tarih: "21.09.2025", il: "Artvin", ilce: "BorÃ§ka", konum: "Ä°lÃ§eler arasÄ± yol", tehlikeTuru: "Sel", olayAdi: "BorÃ§ka KÃ¶prÃ¼ Ã‡Ã¶kmesi", sektor: "Kamu AltyapÄ±", etkiSeviyesi: "YÃ¼ksek", yananAlanHa: 0, insaniEtki: "Belirtilmedi", maddiEtki: "TaÅŸan dere nedeniyle bir kÃ¶prÃ¼ Ã§Ã¶ktÃ¼, ulaÅŸÄ±mda ciddi aksama.", lat: 41.38, lng: 41.67, geometri: "Nokta", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "Artvin BorÃ§ka'da ÅŸiddetli yaÄŸÄ±ÅŸ sonrasÄ± bir kÃ¶prÃ¼nÃ¼n Ã§Ã¶kmesiyle ulaÅŸÄ±m durdu.", kaynaklar: [{kaynak: "KarayollarÄ±", alinti: "Alternatif gÃ¼zergahlar oluÅŸturuluyor."}] },
                { id: "YanginMuglaKoycegiz-Milas2025-09-19", tarih: "19.09.2025", il: "MuÄŸla", ilce: "KÃ¶yceÄŸizâ€“Milas", konum: "Ä°l geneli", tehlikeTuru: "YangÄ±n", olayAdi: "MuÄŸla BÃ¼yÃ¼k Orman YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "YÃ¼ksek", yananAlanHa: 2403, insaniEtki: "Tahliyeler yapÄ±ldÄ±", maddiEtki: "Valilik aÃ§Ä±klamasÄ±na gÃ¶re 2403 hektar alan yandÄ±. TÃ¼rkiye'nin en bÃ¼yÃ¼k yangÄ±nlarÄ±ndan biri.", lat: 37.15, lng: 28.5, geometri: "Ã‡okgen", dogrulamaYontemi: "A", dogrulukOrani: 96, ozet: "MuÄŸla'nÄ±n KÃ¶yceÄŸiz ve Milas ilÃ§elerinde baÅŸlayan ve rÃ¼zgarÄ±n etkisiyle geniÅŸ bir alana yayÄ±lan orman yangÄ±nÄ±nda, valilik verilerine gÃ¶re 2403 hektar alan zarar gÃ¶rdÃ¼.", kaynaklar: [{kaynak: "MuÄŸla ValiliÄŸi", alinti: "Toplam 2403 hektar alan etkilenmiÅŸtir."}] },
                { id: "SelOrdu-FatsaMerkez2025-09-07", tarih: "07.09.2025", il: "Ordu", ilce: "Fatsa", konum: "Ä°lÃ§e merkezi", tehlikeTuru: "Sel", olayAdi: "Fatsa Su BaskÄ±nÄ±", sektor: "Ticari Ä°ÅŸletmeler", etkiSeviyesi: "Orta", yananAlanHa: 0, insaniEtki: "Belirtilmedi", maddiEtki: "Ä°lÃ§e merkezindeki Ã§ok sayÄ±da iÅŸyerini su bastÄ±. Ciddi emtea ve dekorasyon hasarlarÄ±.", lat: 41.03, lng: 37.5, geometri: "Ã‡okgen", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "Ordu'nun Fatsa ilÃ§esinde yaÅŸanan ani sel, ilÃ§e merkezinde su baskÄ±nlarÄ±na yol aÃ§tÄ±. Ã‡ok sayÄ±da dÃ¼kkan zarar gÃ¶rdÃ¼.", kaynaklar: [{kaynak: "Ticaret OdasÄ±", alinti: "EsnafÄ±n zararÄ± bÃ¼yÃ¼k."}] },
                { id: "YanginDenizli-BuldanCevre2025-09-02", tarih: "02.09.2025", il: "Denizli", ilce: "Buldan", konum: "Ã‡atakâ€“SÃ¼leymanlÄ± kÄ±rsalÄ±", tehlikeTuru: "YangÄ±n", olayAdi: "Buldan Orman YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "Orta", yananAlanHa: 250, insaniEtki: "Belirtilmedi", maddiEtki: "GeniÅŸ bir ormanlÄ±k alanda etkili oldu.", lat: 38.04, lng: 28.83, geometri: "Ã‡okgen", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "Denizli'nin Buldan ilÃ§esi kÄ±rsalÄ±nda Ã§Ä±kan orman yangÄ±nÄ±, ekiplerin yoÄŸun Ã§abasÄ±yla kontrol altÄ±na alÄ±ndÄ±.", kaynaklar: [{kaynak: "BakanlÄ±k AÃ§Ä±klamasÄ±", alinti: "Denizli'deki yangÄ±n kontrol altÄ±nda."}] },
                { id: "YanginCanakkale-MerkezErenkoy2025-08-12", tarih: "12.08.2025", il: "Ã‡anakkale", ilce: "Merkez", konum: "ErenkÃ¶y Ã§evresi", tehlikeTuru: "YangÄ±n", olayAdi: "Ã‡anakkale Tarihi Alan YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "YÃ¼ksek", yananAlanHa: 1500, insaniEtki: "YÃ¼zlerce kiÅŸi tahliye edildi", maddiEtki: "Tarihi Gelibolu YarÄ±madasÄ±'na yakÄ±n bÃ¶lgede bÃ¼yÃ¼k Ã§aplÄ± yangÄ±n. YÃ¼zlerce kiÅŸi tahliye edildi.", lat: 40.05, lng: 26.35, geometri: "Ã‡okgen", dogrulamaYontemi: "B", dogrulukOrani: 90, ozet: "Ã‡anakkale merkez ErenkÃ¶y Ã§evresinde Ã§Ä±kan yangÄ±n nedeniyle yÃ¼zlerce kiÅŸi tahliye edildi. YangÄ±n, tarihi alanlarÄ± tehdit etti.", kaynaklar: [{kaynak: "Ulusal BasÄ±n", alinti: "BÃ¶lgeden yÃ¼zlerce kiÅŸi tahliye edildi."}] },
                { id: "YanginEskisehir-SeyitgaziKirka2025-07-23", tarih: "23.07.2025", il: "EskiÅŸehir", ilce: "Seyitgazi", konum: "KÄ±rka Ã§evresi", tehlikeTuru: "YangÄ±n", olayAdi: "Seyitgazi Orman YangÄ±nÄ±", sektor: "Orman", etkiSeviyesi: "YÃ¼ksek", yananAlanHa: 800, insaniEtki: "10 ÅŸehit / 14 yaralÄ± (SÃ¶ndÃ¼rme uÃ§aÄŸÄ± dÃ¼ÅŸtÃ¼)", maddiEtki: "GeniÅŸ bir alanda etkili olan yangÄ±na mÃ¼dahale sÄ±rasÄ±nda sÃ¶ndÃ¼rme uÃ§aÄŸÄ±nÄ±n dÃ¼ÅŸmesi sonucu can kayÄ±plarÄ± yaÅŸandÄ±.", lat: 39.45, lng: 30.69, geometri: "Ã‡okgen", dogrulamaYontemi: "A", dogrulukOrani: 100, ozet: "EskiÅŸehir Seyitgazi'deki orman yangÄ±nÄ±na mÃ¼dahale eden bir uÃ§aÄŸÄ±n dÃ¼ÅŸmesi sonucu 10 personel ÅŸehit oldu, 14 personel yaralandÄ±. YangÄ±n, trajik bir olayla sonuÃ§landÄ±.", kaynaklar: [{kaynak: "Resmi AÃ§Ä±klama", alinti: "Maalesef can kayÄ±plarÄ±mÄ±z var."}] },
                { id: "SelAnkara-MerkezMultiple2025-07-18", tarih: "18.07.2025", il: "Ankara", ilce: "Merkez", konum: "Ä°l geneli", tehlikeTuru: "Sel", olayAdi: "Ankara Sel BaskÄ±nÄ±", sektor: "Kentsel AltyapÄ±", etkiSeviyesi: "Orta", yananAlanHa: 0, insaniEtki: "Belirtilmedi", maddiEtki: "Ankara'nÄ±n birÃ§ok ilÃ§esinde ani sel baskÄ±nlarÄ± yaÅŸandÄ±. Ã‡ok sayÄ±da ev ve iÅŸyerini su bastÄ±, altyapÄ± zarar gÃ¶rdÃ¼.", lat: 39.93, lng: 32.85, geometri: "Ã‡okgen", dogrulamaYontemi: "A", dogrulukOrani: 95, ozet: "Ankara'da etkili olan ÅŸiddetli yaÄŸÄ±ÅŸlar, altyapÄ±nÄ±n yetersiz kaldÄ±ÄŸÄ± bÃ¶lgelerde sel baskÄ±nlarÄ±na neden oldu.", kaynaklar: [{kaynak: "Belediye", alinti: "Kritik noktalara mÃ¼dahale ediliyor."}] }
            ];

            let map, markersLayer, polylinesLayer, tehlikeChart, aylikChart;
            let currentIncident = null;
            let currentFilteredData = incidentsData;
            const elements = { 
                ilFilter: document.getElementById('il-filter'), 
                tehlikeFilter: document.getElementById('tehlike-filter'), 
                etkiFilter: document.getElementById('etki-filter'), 
                incidentList: document.getElementById('incident-list'), 
                resultCount: document.getElementById('result-count'), 
                resetBtn: document.getElementById('reset-filters'), 
                detailsPanel: document.getElementById('details-panel'), 
                analysisPanel: document.getElementById('analysis-panel'), 
                mainContentArea: document.getElementById('main-content-area'), 
                mapContainer: document.getElementById('map-container'), 
                geminiModal: document.getElementById('gemini-modal'), 
                modalContentBox: document.getElementById('gemini-modal-content-box'), 
                modalTitle: document.getElementById('modal-title'), 
                modalContent: document.getElementById('modal-content'), 
                modalLoading: document.getElementById('modal-loading'), 
                modalCloseBtn: document.getElementById('modal-close-btn'), 
                modalCloseBtnIcon: document.getElementById('modal-close-btn-icon'), 
                generateAnalysisBtn: document.getElementById('generate-analysis-btn'),
                generateReportBtn: document.getElementById('generate-report-btn'),
                analysisCards: document.getElementById('analysis-cards') 
            };

            function init() { populateFilters(); initMap(); renderAll(incidentsData); addEventListeners(); }

            function addEventListeners() {
                elements.ilFilter.addEventListener('change', applyFilters);
                elements.tehlikeFilter.addEventListener('change', applyFilters);
                elements.etkiFilter.addEventListener('change', applyFilters);
                elements.resetBtn.addEventListener('click', resetAllFilters);
                elements.incidentList.addEventListener('click', handleListClick);
                elements.modalCloseBtn.addEventListener('click', closeModal);
                elements.modalCloseBtnIcon.addEventListener('click', closeModal);
                elements.generateAnalysisBtn.addEventListener('click', handleGenerateAnalysis);
                elements.generateReportBtn.addEventListener('click', handleGenerateReport);
            }

            function renderAll(data) { renderIncidentList(data); updateAnalysis(data); updateMapMarkers(data); }

            function populateFilters() {
                const iller = [...new Set(incidentsData.map(item => item.il))].sort((a, b) => a.localeCompare(b, 'tr'));
                const tehlikeler = [...new Set(incidentsData.map(item => item.tehlikeTuru))].sort();
                iller.forEach(il => elements.ilFilter.innerHTML += `<option value="${il}">${il}</option>`);
                tehlikeler.forEach(tehlike => elements.tehlikeFilter.innerHTML += `<option value="${tehlike}">${tehlike}</option>`);
            }

            function renderIncidentList(data) {
                elements.incidentList.innerHTML = data.length === 0 ? '<p class="text-gray-500 text-center p-4">Filtre kriterlerine uygun sonuÃ§ bulunamadÄ±.</p>' : '';
                if(data.length > 0) {
                    data.sort((a, b) => {
                        const dateA = new Date(a.tarih.split('.').reverse().join('-'));
                        const dateB = new Date(b.tarih.split('.').reverse().join('-'));
                        return dateB - dateA;
                    });
                    data.forEach(item => {
                        const etkiRenk = { 'YÃ¼ksek': 'border-red-500', 'Orta': 'border-yellow-500', 'DÃ¼ÅŸÃ¼k': 'border-green-500' }[item.etkiSeviyesi] || 'border-gray-200';
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `p-3 border-l-4 ${etkiRenk} cursor-pointer hover:bg-gray-100 transition duration-150 rounded-r-md`;
                        itemDiv.dataset.id = item.id;
                        itemDiv.innerHTML = `<div class="flex justify-between items-start"><p class="font-bold text-base text-gray-800">${item.olayAdi}</p><span class="text-xs font-medium text-gray-500">${item.tarih}</span></div><p class="text-sm text-gray-600">${item.il}, ${item.ilce}</p><p class="text-xs text-gray-500 mt-1 font-semibold">${item.tehlikeTuru}</p>`;
                        elements.incidentList.appendChild(itemDiv);
                    });
                }
                elements.resultCount.textContent = `${data.length} sonuÃ§ bulundu.`;
            }

            function showDetails(incident) {
                elements.analysisPanel.classList.add('hidden');
                elements.mapContainer.classList.add('hidden');
                const etkiBilgi = { 'YÃ¼ksek': { renk: 'red', ikon: 'fa-triangle-exclamation', metin: 'YÃ¼ksek Etki' }, 'Orta': { renk: 'yellow', ikon: 'fa-circle-exclamation', metin: 'Orta Etki' }, 'DÃ¼ÅŸÃ¼k': { renk: 'green', ikon: 'fa-circle-info', metin: 'DÃ¼ÅŸÃ¼k Etki' } }[incident.etkiSeviyesi];
                
                let yananAlanHTML = incident.tehlikeTuru === 'YangÄ±n' && incident.yananAlanHa > 0 ? `<div class="bg-red-50 p-3 rounded-lg text-center"><p class="font-semibold text-red-500">Yanan Alan</p><p class="font-bold text-2xl text-red-800">${incident.yananAlanHa.toLocaleString('tr-TR')} ha</p></div>` : '';
                let insaniEtkiHTML = incident.insaniEtki !== 'Belirtilmedi' ? `<div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Ä°nsani Etki</p><p class="font-medium text-lg">${incident.insaniEtki}</p></div>` : `<div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Tarih</p><p class="font-medium text-lg">${incident.tarih}</p></div>`;
                let etkilenenTesislerHTML = incident.etkilenenTesislerDetay ? `<div class="mt-4"><h4 class="font-bold text-sky-700 flex items-center gap-2"><i class="fa-solid fa-industry"></i> Etkilenen Kritik Tesis(ler)</h4><ul class="text-sm bg-sky-50 p-3 rounded-lg mt-1 border border-sky-200 space-y-1">${incident.etkilenenTesislerDetay.map(p => `<li><strong>${p.ad}</strong></li>`).join('')}</ul></div>` : '';

                elements.detailsPanel.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2"><div class="flex justify-between items-start relative"><button onclick="resetToAnalysisView()" class="absolute top-0 right-0 text-gray-500 hover:text-gray-800 font-bold p-2 text-2xl z-10">&times;</button><div><span class="inline-block px-3 py-1 text-sm font-semibold text-${etkiBilgi.renk}-800 bg-${etkiBilgi.renk}-100 rounded-full mb-2"><i class="fa-solid ${etkiBilgi.ikon} mr-2"></i>${etkiBilgi.metin}</span><h2 class="text-3xl font-bold text-gray-800">${incident.olayAdi}</h2><p class="text-md text-gray-500 mt-1">${incident.konum}, ${incident.ilce}/${incident.il}</p></div></div><div class="grid grid-cols-2 gap-4 text-sm mt-6">${yananAlanHTML}<div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Tehlike TÃ¼rÃ¼</p><p class="font-medium text-lg">${incident.tehlikeTuru}</p></div><div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Etkilenen VarlÄ±k</p><p class="font-medium text-lg">${incident.sektor}</p></div>${insaniEtkiHTML}</div><div class="mt-4"><h4 class="font-bold text-gray-700">Olay Ã–zeti</h4><p class="text-sm mt-1 bg-blue-50 p-3 rounded-lg border border-blue-200">${incident.ozet}</p></div><div class="mt-4"><h4 class="font-bold text-gray-700">Potansiyel Sigorta Etkisi</h4><p class="text-sm mt-1">${incident.maddiEtki}</p></div>${etkilenenTesislerHTML}</div><div class="md:col-span-1 h-full min-h-[400px]"><div id="detail-map" class="w-full h-full rounded-lg shadow-md"></div></div></div>`;
                elements.detailsPanel.classList.remove('hidden');
                
                const detailMap = L.map('detail-map').setView([incident.lat, incident.lng], 12);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(detailMap);
                L.marker([incident.lat, incident.lng], { icon: createMapIcon(incident) }).addTo(detailMap).bindPopup(`<b>${incident.olayAdi}</b>`).openPopup();
                if (incident.etkilenenTesislerDetay) {
                    incident.etkilenenTesislerDetay.forEach(tesis => {
                        L.marker([tesis.lat, tesis.lng], { icon: createMapIcon(null, 'tesis') })
                            .addTo(detailMap)
                            .bindPopup(`<b>Etkilenen Tesis:</b> ${tesis.ad}`);
                        L.polyline([[incident.lat, incident.lng], [tesis.lat, tesis.lng]], { color: '#0ea5e9', dashArray: '5, 10' }).addTo(detailMap);
                    });
                }
            }

            function updateAnalysis(data) {
                const totalIncidents = data.length;
                const highImpactCount = data.filter(i => i.etkiSeviyesi === 'YÃ¼ksek').length;
                const totalHectares = data.reduce((sum, i) => sum + (i.yananAlanHa || 0), 0);
                const mostAffectedCity = Object.entries(data.reduce((acc, item) => { acc[item.il] = (acc[item.il] || 0) + 1; return acc; }, {})).sort((a,b) => b[1] - a[1])[0] || ['-', 0];

                elements.analysisCards.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200"><p class="text-sm text-blue-700 font-semibold">Toplam Vaka</p><p class="text-3xl font-bold text-blue-900">${totalIncidents}</p></div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200"><p class="text-sm text-red-700 font-semibold">Toplam Yanan Alan (ha)</p><p class="text-3xl font-bold text-red-900">${totalHectares.toLocaleString('tr-TR')}</p></div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200"><p class="text-sm text-yellow-700 font-semibold">En Riskli BÃ¶lge</p><p class="text-xl font-bold text-yellow-900">${mostAffectedCity[0]}</p></div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200"><p class="text-sm text-green-700 font-semibold">YÃ¼ksek Etkili Vaka</p><p class="text-3xl font-bold text-green-900">${highImpactCount}</p></div>`;
                updateCharts(data);
            }
            
            function applyFilters() { 
                const filters = { 
                    il: elements.ilFilter.value, 
                    tehlike: elements.tehlikeFilter.value, 
                    etki: elements.etkiFilter.value 
                }; 
                currentFilteredData = incidentsData.filter(item => 
                    (filters.il === 'all' || item.il === filters.il) && 
                    (filters.tehlike === 'all' || item.tehlikeTuru === filters.tehlike) && 
                    (filters.etki === 'all' || item.etkiSeviyesi === filters.etki)
                ); 
                renderAll(currentFilteredData); 
                resetToAnalysisView(); 
            }
            
            function resetAllFilters() { 
                elements.ilFilter.value = 'all'; 
                elements.tehlikeFilter.value = 'all'; 
                elements.etkiFilter.value = 'all'; 
                applyFilters(); 
                map.setView([39.0, 35.0], 6); 
            }

            window.resetToAnalysisView = function() { 
                elements.detailsPanel.classList.add('hidden'); 
                elements.analysisPanel.classList.remove('hidden'); 
                elements.mapContainer.classList.remove('hidden'); 
                currentIncident = null; 
                document.querySelectorAll('.active-item').forEach(el => el.classList.remove('active-item')); 
                if (map) map.invalidateSize(); 
            }

            function handleListClick(e) {
                const itemDiv = e.target.closest('[data-id]');
                if (itemDiv) { 
                    const incidentId = itemDiv.dataset.id; 
                    currentIncident = incidentsData.find(i => i.id === incidentId); 
                    document.querySelectorAll('.active-item').forEach(el => el.classList.remove('active-item')); 
                    itemDiv.classList.add('active-item'); 
                    itemDiv.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                    showDetails(currentIncident); 
                    if (map) map.flyTo([currentIncident.lat, currentIncident.lng], 11); 
                }
            }
            
            function initMap() { 
                map = L.map('map').setView([39.0, 35.0], 6); 
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>' }).addTo(map); 
                markersLayer = L.layerGroup().addTo(map); 
                polylinesLayer = L.layerGroup().addTo(map);
            }
            
            function createMapIcon(incident, type = 'main') {
                if (type === 'tesis') {
                    return L.divIcon({ 
                        html: `<div style="font-size: 20px; color: #0ea5e9; text-shadow: 0 0 4px white;"><i class="fa-solid fa-industry"></i></div>`, 
                        className: 'leaflet-div-icon', 
                        iconSize: [24, 24], 
                        iconAnchor: [12, 12] 
                    });
                }
                const icons = { 'YangÄ±n': 'fa-fire', 'Sel': 'fa-house-flood-water' }; 
                const colors = { 'YÃ¼ksek': '#ef4444', 'Orta': '#f59e0b', 'DÃ¼ÅŸÃ¼k': '#22c55e' }; 
                const iconClass = icons[incident.tehlikeTuru] || 'fa-circle-question'; 
                const color = colors[incident.etkiSeviyesi] || '#6b7280'; 
                return L.divIcon({ 
                    html: `<div style="font-size: 24px; color: ${color}; text-shadow: 0 0 4px white;"><i class="fa-solid ${iconClass}"></i></div>`, 
                    className: 'leaflet-div-icon', 
                    iconSize: [24, 24], 
                    iconAnchor: [12, 12] 
                }); 
            }

            function updateMapMarkers(data) {
                markersLayer.clearLayers();
                polylinesLayer.clearLayers();
                data.forEach(item => {
                    const marker = L.marker([item.lat, item.lng], { icon: createMapIcon(item) }).addTo(markersLayer);
                    marker.bindPopup(`<b>${item.olayAdi}</b><br>${item.tehlikeTuru}`).on('click', () => handleListClick({ target: document.querySelector(`[data-id="${item.id}"]`) }));
                    if (item.etkilenenTesislerDetay) {
                        item.etkilenenTesislerDetay.forEach(tesis => {
                            const tesisMarker = L.marker([tesis.lat, tesis.lng], { icon: createMapIcon(null, 'tesis') }).addTo(markersLayer);
                            tesisMarker.bindPopup(`<b>Etkilenen Tesis:</b><br>${tesis.ad}`);
                            L.polyline([[item.lat, item.lng], [tesis.lat, tesis.lng]], { color: '#0ea5e9', dashArray: '5, 10' }).addTo(polylinesLayer);
                        });
                    }
                });
            }

            function createOrUpdateChart(chartInstance, elementId, type, data, options) { 
                if (chartInstance) { chartInstance.destroy(); } 
                const ctx = document.getElementById(elementId).getContext('2d'); 
                return new Chart(ctx, { type, data, options }); 
            }
            
            function updateCharts(data) {
                const tehlikeData = data.reduce((acc, item) => { acc[item.tehlikeTuru] = (acc[item.tehlikeTuru] || 0) + 1; return acc; }, {});
                tehlikeChart = createOrUpdateChart(tehlikeChart, 'tehlikeChart', 'doughnut', { 
                    labels: Object.keys(tehlikeData), 
                    datasets: [{ 
                        label: 'Vaka SayÄ±sÄ±', 
                        data: Object.values(tehlikeData), 
                        backgroundColor: ['rgba(239, 68, 68, 0.7)', 'rgba(59, 130, 246, 0.7)'],
                        borderColor: ['#ef4444', '#3b82f6'],
                        borderWidth: 1
                    }] 
                }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } });

                const aylikDataRaw = data.reduce((acc, item) => { const month = item.tarih.substring(3, 10); acc[month] = (acc[month] || 0) + 1; return acc; }, {});
                const sortedAylikData = Object.entries(aylikDataRaw).sort((a, b) => { const [m1, y1] = a[0].split('.'); const [m2, y2] = b[0].split('.'); return new Date(y1, m1-1) - new Date(y2, m2-1); });
                aylikChart = createOrUpdateChart(aylikChart, 'aylikChart', 'line', { 
                    labels: sortedAylikData.map(d => d[0]), 
                    datasets: [{ 
                        label: 'Vaka SayÄ±sÄ±', 
                        data: sortedAylikData.map(d => d[1]), 
                        backgroundColor: 'rgba(22, 163, 74, 0.1)', 
                        borderColor: '#16a34a', 
                        tension: 0.3, 
                        fill: true, 
                        pointBackgroundColor: '#16a34a' 
                    }] 
                }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } });
            }

            function handleGenerateReport() {
                const reportTitle = `<i class="fa-solid fa-chart-simple mr-2"></i> FiltrelenmiÅŸ Veri Raporu`;
                let reportContent = '';

                const fireData = currentFilteredData.filter(d => d.tehlikeTuru === 'YangÄ±n');
                reportContent += `<h3>Orman YangÄ±nÄ± Raporu</h3>`;
                if (fireData.length > 0) {
                    const fireByCity = fireData.reduce((acc, item) => { acc[item.il] = (acc[item.il] || 0) + 1; return acc; }, {});
                    const topFireCity = Object.entries(fireByCity).sort((a, b) => b[1] - a[1])[0];
                    const totalBurnedArea = fireData.reduce((sum, i) => sum + (i.yananAlanHa || 0), 0);
                    reportContent += `<ul class="list-disc pl-5">
                                        <li>Toplam <b>${fireData.length}</b> yangÄ±n vakasÄ± bulunmaktadÄ±r.</li>
                                        <li>En fazla yangÄ±n gÃ¶rÃ¼len il: <b>${topFireCity[0]}</b> (${topFireCity[1]} vaka)</li>
                                        <li>Filtrelenen veride yanan toplam alan: <b>${totalBurnedArea.toLocaleString('tr-TR')} hektar</b>.</li>
                                      </ul><br>`;
                } else {
                    reportContent += `<p>Filtre kriterlerine uygun yangÄ±n verisi bulunamadÄ±.</p><br>`;
                }

                const floodData = currentFilteredData.filter(d => d.tehlikeTuru === 'Sel');
                reportContent += `<h3>Sel Raporu</h3>`;
                if (floodData.length > 0) {
                    const floodByCity = floodData.reduce((acc, item) => { acc[item.il] = (acc[item.il] || 0) + 1; return acc; }, {});
                    const topFloodCity = Object.entries(floodByCity).sort((a, b) => b[1] - a[1])[0];
                    const affectedInfrastructure = floodData.filter(d => d.sektor.includes('AltyapÄ±') || d.sektor.includes('Enerji') || d.sektor.includes('Ticari')).length;
                    reportContent += `<ul class="list-disc pl-5">
                                        <li>Toplam <b>${floodData.length}</b> sel vakasÄ± bulunmaktadÄ±r.</li>
                                        <li>En fazla sel gÃ¶rÃ¼len il: <b>${topFloodCity[0]}</b> (${topFloodCity[1]} vaka)</li>
                                        <li>AltyapÄ±, enerji veya ticari tesisleri etkileyen vaka sayÄ±sÄ±: <b>${affectedInfrastructure}</b>.</li>
                                      </ul><br>`;
                } else {
                    reportContent += `<p>Filtre kriterlerine uygun sel verisi bulunamadÄ±.</p><br>`;
                }

                const aylikDataRaw = currentFilteredData.reduce((acc, item) => { const month = item.tarih.substring(3, 10); acc[month] = (acc[month] || 0) + 1; return acc; }, {});
                const sortedAylikData = Object.entries(aylikDataRaw).sort((a, b) => { const [m1, y1] = a[0].split('.'); const [m2, y2] = b[0].split('.'); return new Date(y1, m1-1) - new Date(y2, m2-1); });
                
                reportContent += `<h3>Aylara GÃ¶re Vaka DaÄŸÄ±lÄ±mÄ±</h3>`;
                if(sortedAylikData.length > 0) {
                    reportContent += `<ul class="list-disc pl-5">${sortedAylikData.map(d => `<li><b>${d[0]}:</b> ${d[1]} vaka</li>`).join('')}</ul>`;
                } else {
                    reportContent += `<p>AylÄ±k daÄŸÄ±lÄ±m iÃ§in veri bulunamadÄ±.</p>`;
                }
                
                openModal(reportTitle);
                elements.modalContent.innerHTML = reportContent.replace(/<h3>/g, '<h3 class="text-lg font-semibold mb-2 mt-4 text-indigo-700">');
                elements.modalLoading.style.display = 'none';
            }
            
            function handleGenerateAnalysis() {
                const summary = `Mevcut filtrelemeye gÃ¶re ${currentFilteredData.length} doÄŸal afet vakasÄ± incelenmektedir. BunlarÄ±n ${currentFilteredData.filter(i=>i.tehlikeTuru==='YangÄ±n').length}'i yangÄ±n, ${currentFilteredData.filter(i=>i.tehlikeTuru==='Sel').length}'i sel vakasÄ±dÄ±r. YangÄ±nlarda toplam yanan alan yaklaÅŸÄ±k ${currentFilteredData.reduce((sum, i) => sum + (i.yananAlanHa || 0), 0).toLocaleString('tr-TR')} hektardÄ±r. YÃ¼ksek etkili vakalarÄ±n toplam iÃ§indeki oranÄ± %${(currentFilteredData.filter(i=>i.etkiSeviyesi === 'YÃ¼ksek').length / currentFilteredData.length * 100).toFixed(0)}'dÄ±r. En Ã§ok vaka gÃ¶rÃ¼len il: ${Object.keys(currentFilteredData.reduce((acc, item) => { acc[item.il] = (acc[item.il] || 0) + 1; return acc; }, {})).sort((a,b) => b[1] - a[1])[0] || '-'}.`;
                const prompt = `Sen TÃ¼rkiye doÄŸal afet sigortalarÄ± (CAT) alanÄ±nda uzman bir risk analisti ve portfÃ¶y yÃ¶neticisisin. AÅŸaÄŸÄ±da Ã¶zetlenen doÄŸal afet verilerine dayanarak, Ã¼st yÃ¶netime sunulacak kÄ±sa, net ve etkili bir analiz raporu oluÅŸtur. Raporu Markdown formatÄ±nda, baÅŸlÄ±klar ve listeler kullanarak hazÄ±rla. Rapor TÃ¼rkÃ§e olmalÄ± ve ÅŸu baÅŸlÄ±klarÄ± iÃ§ermelidir:\n### 1. GÃ¶zlemlenen Afet Trendleri ve YoÄŸunlaÅŸma BÃ¶lgeleri\n### 2. PortfÃ¶y ve Underwriting Stratejisi iÃ§in Ã‡Ä±karÄ±mlar (BÃ¶lgesel risk birikimi (accumulation), riskli altyapÄ± tesisleri ve DASK dÄ±ÅŸÄ± konut/iÅŸyeri poliÃ§eleri iÃ§in Ã¶neriler)\n### 3. Hasar Ã–nleme ve Risk YÃ¶netimi Ã–nerileri (Hem sigortalÄ±lar hem de ÅŸirket iÃ§in alÄ±nabilecek Ã¶nlemler)\n**Analiz Edilecek Veri Ã–zeti:**\n${summary}`;
                callGeminiAPI(prompt, `<i class="fa-solid fa-chart-pie mr-2"></i> Genel NAT CAT Risk Analizi`);
            }
            
            async function callGeminiAPI(prompt, title) {
                openModal(title);
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API hatasÄ±: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) { elements.modalContent.innerHTML = convertMarkdownToHtml(text); } 
                    else { elements.modalContent.textContent = "Yapay zekadan geÃ§erli bir yanÄ±t alÄ±namadÄ±."; }
                } catch (error) { 
                    console.error("Gemini API Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z:", error); 
                    elements.modalContent.textContent = `Bir hata oluÅŸtu: ${error.message}.`; 
                } finally { 
                    elements.modalLoading.style.display = 'none'; 
                }
            }

            function openModal(title) { 
                elements.modalTitle.innerHTML = title; 
                elements.modalContent.innerHTML = ''; 
                elements.modalLoading.style.display = 'flex'; 
                elements.geminiModal.classList.remove('hidden'); 
                setTimeout(() => { elements.modalContentBox.classList.remove('scale-95', 'opacity-0'); }, 10); 
            }
            function closeModal() { 
                elements.modalContentBox.classList.add('scale-95', 'opacity-0'); 
                setTimeout(() => { elements.geminiModal.classList.add('hidden'); }, 300); 
            }
            function convertMarkdownToHtml(md) { 
                md = md.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mb-2 mt-4">$1</h3>')
                       .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mb-3 mt-5">$1</h2>')
                       .replace(/^\* (.*$)/gim, '<li class="ml-4 mb-1">$1</li>')
                       .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                       .replace(/\n/g, '<br>'); 
                return md.replace(/<br><li/g, '<li').replace(/<\/strong><br>/g, '</strong> '); 
            }

            init();
        });
    </script>
</body>
</html>

